<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Accelerating tidy list-column workflows with collateral • collateral</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Accelerating tidy list-column workflows with collateral">
<meta property="og:description" content="">
<meta property="og:image" content="/logo.png">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">collateral</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/collateral.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/rensa/collateral">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Accelerating tidy list-column workflows with collateral</h1>
                        <h4 class="author">James Goldie</h4>
            
            <h4 class="date">2020-05-24</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/rensa/collateral/blob/master/vignettes/collateral.Rmd"><code>vignettes/collateral.Rmd</code></a></small>
      <div class="hidden name"><code>collateral.Rmd</code></div>

    </div>

    
    
<p>The <a href="https://purrr.tidyverse.org"><code>purrr</code></a> package has a comprehensive set of tools for working with lists and vectors, and especially for iterating operations and analyses with its <a href="https://purrr.tidyverse.org/reference/map.html"><code>map()</code></a>. This style of iteration is particularly powerful when used with the <a href="https://tibble.tidyverse.org/"><code>tibble</code></a> package, because—unlike regular data frames—tibbles allow you to use lists as data frame columns as well as vectors. That means that complex objects, including models, plots and even other data frames can be stored inside a data frame list-column alongside other data.</p>
<p>The biggest downside of being able to do complex analysis on many list elements is that one little error can bring a lot of computation down. Another is that a warning or other message might get lost: if the 37th statistical model you fit of 45 has a problem, are you going to catch it?</p>
<p><code>purrr</code> comes with tools for dealing with errors, warnings and other “side effects”, but it’s difficult to pair them effectively with <code>purrr</code>’s massively powerful iteration tools. And that’s where <code>collateral</code> comes in: it gives you ways to drop-in replacements for <code>map()</code> that use employ these side-effect capturing tools, as well as an array of other helpers to make navigating everything you’ve captured more pleasant.</p>
<div id="contents" class="section level1">
<h1 class="hasAnchor">
<a href="#contents" class="anchor"></a>Contents</h1>
<ul>
<li><a href="#eda">Basic exploratory analysis</a></li>
<li><a href="#basegrouping">Grouping the traditional way</a></li>
<li><a href="#purrrnesting">Nesting and handling side effects with purrr</a></li>
<li><a href="#collateraluse">Collateral: capture, identify and isolate side effects</a></li>
<li><a href="#helpers">Filtering on, and summarising, side effects</a></li>
</ul>
</div>
<div id="eda" class="section level1">
<h1 class="hasAnchor">
<a href="#eda" class="anchor"></a>Basic exploratory analysis</h1>
<p>The aim of this vignette isn’t just to get you acquainted with <code>collateral</code>’s tools: it’s also to demonstrate the value of a tidy list-column workflow. We’ll be using the <code>diamonds</code> dataset, which comes with the <a href="https://ggplot2.tidyverse.org"><code>ggplot2</code></a> package. Let’s take a look:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co">#&gt; -- Attaching packages ------------------------------------- tidyverse 1.2.1 --</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co">#&gt; v ggplot2 3.3.0           v purrr   0.3.3      </span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co">#&gt; v tibble  3.0.0           v dplyr   0.8.99.9002</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co">#&gt; v tidyr   1.0.2           v stringr 1.4.0      </span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co">#&gt; v readr   1.3.1           v forcats 0.5.0</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co">#&gt; Warning: package 'tibble' was built under R version 3.6.3</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co">#&gt; Warning: package 'tidyr' was built under R version 3.6.3</span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co">#&gt; Warning: package 'purrr' was built under R version 3.6.3</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co">#&gt; Warning: package 'forcats' was built under R version 3.6.3</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co">#&gt; -- Conflicts ---------------------------------------- tidyverse_conflicts() --</span></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="co">#&gt; x dplyr::filter() masks stats::filter()</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="co">#&gt; x dplyr::lag()    masks stats::lag()</span></span>
<span id="cb1-14"><a href="#cb1-14"></a></span>
<span id="cb1-15"><a href="#cb1-15"></a>diamonds</span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="co">#&gt; # A tibble: 53,940 x 10</span></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="co">#&gt;    carat cut       color clarity depth table price     x     y     z</span></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="co">#&gt;    &lt;dbl&gt; &lt;ord&gt;     &lt;ord&gt; &lt;ord&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb1-19"><a href="#cb1-19"></a><span class="co">#&gt;  1 0.23  Ideal     E     SI2      61.5    55   326  3.95  3.98  2.43</span></span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="co">#&gt;  2 0.21  Premium   E     SI1      59.8    61   326  3.89  3.84  2.31</span></span>
<span id="cb1-21"><a href="#cb1-21"></a><span class="co">#&gt;  3 0.23  Good      E     VS1      56.9    65   327  4.05  4.07  2.31</span></span>
<span id="cb1-22"><a href="#cb1-22"></a><span class="co">#&gt;  4 0.290 Premium   I     VS2      62.4    58   334  4.2   4.23  2.63</span></span>
<span id="cb1-23"><a href="#cb1-23"></a><span class="co">#&gt;  5 0.31  Good      J     SI2      63.3    58   335  4.34  4.35  2.75</span></span>
<span id="cb1-24"><a href="#cb1-24"></a><span class="co">#&gt;  6 0.24  Very Good J     VVS2     62.8    57   336  3.94  3.96  2.48</span></span>
<span id="cb1-25"><a href="#cb1-25"></a><span class="co">#&gt;  7 0.24  Very Good I     VVS1     62.3    57   336  3.95  3.98  2.47</span></span>
<span id="cb1-26"><a href="#cb1-26"></a><span class="co">#&gt;  8 0.26  Very Good H     SI1      61.9    55   337  4.07  4.11  2.53</span></span>
<span id="cb1-27"><a href="#cb1-27"></a><span class="co">#&gt;  9 0.22  Fair      E     VS2      65.1    61   337  3.87  3.78  2.49</span></span>
<span id="cb1-28"><a href="#cb1-28"></a><span class="co">#&gt; 10 0.23  Very Good H     VS1      59.4    61   338  4     4.05  2.39</span></span>
<span id="cb1-29"><a href="#cb1-29"></a><span class="co">#&gt; # ... with 53,930 more rows</span></span></code></pre></div>
<p>This dataset describes the prices and properties of about fifty thousand diamonds. We can see a number of categorical variables, including <code>cut</code>, <code>color</code> and <code>clarity</code>, and several continuous variables, like the <code>price</code>.</p>
<p>How is <code>price</code> distributed?</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="kw">ggplot</span>(diamonds) <span class="op">+</span></span>
<span id="cb2-2"><a href="#cb2-2"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">x =</span> price, <span class="dt">y =</span> <span class="kw">stat</span>(count)))</span>
<span id="cb2-3"><a href="#cb2-3"></a><span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span></code></pre></div>
<p><img src="collateral_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="kw">ggplot</span>(diamonds) <span class="op">+</span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">x =</span> price, <span class="dt">y =</span> <span class="kw">stat</span>(count))) <span class="op">+</span></span>
<span id="cb3-4"><a href="#cb3-4"></a><span class="st">  </span><span class="kw">scale_x_log10</span>()</span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span></code></pre></div>
<p><img src="collateral_files/figure-html/unnamed-chunk-2-2.png" width="700"> Looking at a histogram with a logarithmic scale, we can see that it has multiple peaks. That probably means that there are several distinct groups in the data. Maybe there’s a relationship between <code>price</code> and one (or more) of the categorical variables.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="kw">ggplot</span>(diamonds) <span class="op">+</span></span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">x =</span> price, <span class="dt">y =</span> <span class="kw">stat</span>(count))) <span class="op">+</span></span>
<span id="cb4-3"><a href="#cb4-3"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="kw">vars</span>(cut), <span class="dt">ncol =</span> <span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="st">  </span><span class="kw">scale_x_log10</span>() <span class="op">+</span></span>
<span id="cb4-5"><a href="#cb4-5"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">'Price vs. cut'</span>)</span>
<span id="cb4-6"><a href="#cb4-6"></a><span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span></code></pre></div>
<p><img src="collateral_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="kw">ggplot</span>(diamonds) <span class="op">+</span></span>
<span id="cb5-3"><a href="#cb5-3"></a><span class="st">  </span><span class="kw">geom_histogram</span>(<span class="kw">aes</span>(<span class="dt">x =</span> price, <span class="dt">y =</span> <span class="kw">stat</span>(count))) <span class="op">+</span></span>
<span id="cb5-4"><a href="#cb5-4"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="kw">vars</span>(color), <span class="dt">ncol =</span> <span class="dv">1</span>) <span class="op">+</span></span>
<span id="cb5-5"><a href="#cb5-5"></a><span class="st">  </span><span class="kw">scale_x_log10</span>() <span class="op">+</span></span>
<span id="cb5-6"><a href="#cb5-6"></a><span class="st">  </span><span class="kw">ggtitle</span>(<span class="st">'Price vs. color'</span>)</span>
<span id="cb5-7"><a href="#cb5-7"></a><span class="co">#&gt; `stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</span></span></code></pre></div>
<p><img src="collateral_files/figure-html/unnamed-chunk-3-2.png" width="700"></p>
</div>
<div id="basegrouping" class="section level1">
<h1 class="hasAnchor">
<a href="#basegrouping" class="anchor"></a>Grouping the traditional way</h1>
<p>It looks like there might be several relationships here, but let’s focus on <code>cut</code> and <code>color</code> for now. <code>ggplot2</code> makes it very easy to visualise differences across a couple of grouping variables, but we may not always want to create a facetted plot. In fact, there may be lots of activities we want to do that don’t involve plotting at all.</p>
<p>This is a broad class of problem in data analysis called <a href="https://4dpiecharts.com/2011/12/16/a-quick-primer-on-split-apply-combine-problems/">‘split-apply-combine’</a>: <em>split</em> data up into groups, <em>apply</em> operations to those groups and <em>combine</em> the results. One way of doing this with base R is to use <a href="https://stat.ethz.ch/R-manual/R-devel/library/base/html/split.html"><code><a href="https://www.rdocumentation.org/packages/base/topics/split">split()</a></code></a>, which takes in a data frame and some grouping variables and gives you back a list of identically-structured data frames broken up row-wise according to the values of the grouping variables.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>diamonds <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/split">split</a></span>(diamonds<span class="op">$</span>cut)</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="co">#&gt; $Fair</span></span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="co">#&gt; # A tibble: 1,610 x 10</span></span>
<span id="cb6-4"><a href="#cb6-4"></a><span class="co">#&gt;    carat cut   color clarity depth table price     x     y     z</span></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="co">#&gt;    &lt;dbl&gt; &lt;ord&gt; &lt;ord&gt; &lt;ord&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="co">#&gt;  1  0.22 Fair  E     VS2      65.1    61   337  3.87  3.78  2.49</span></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="co">#&gt;  2  0.86 Fair  E     SI2      55.1    69  2757  6.45  6.33  3.52</span></span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co">#&gt;  3  0.96 Fair  F     SI2      66.3    62  2759  6.27  5.95  4.07</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="co">#&gt;  4  0.7  Fair  F     VS2      64.5    57  2762  5.57  5.53  3.58</span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="co">#&gt;  5  0.7  Fair  F     VS2      65.3    55  2762  5.63  5.58  3.66</span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="co">#&gt;  6  0.91 Fair  H     SI2      64.4    57  2763  6.11  6.09  3.93</span></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="co">#&gt;  7  0.91 Fair  H     SI2      65.7    60  2763  6.03  5.99  3.95</span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="co">#&gt;  8  0.98 Fair  H     SI2      67.9    60  2777  6.05  5.97  4.08</span></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="co">#&gt;  9  0.84 Fair  G     SI1      55.1    67  2782  6.39  6.2   3.47</span></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="co">#&gt; 10  1.01 Fair  E     I1       64.5    58  2788  6.29  6.21  4.03</span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="co">#&gt; # ... with 1,600 more rows</span></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="co">#&gt; </span></span>
<span id="cb6-18"><a href="#cb6-18"></a><span class="co">#&gt; $Good</span></span>
<span id="cb6-19"><a href="#cb6-19"></a><span class="co">#&gt; # A tibble: 4,906 x 10</span></span>
<span id="cb6-20"><a href="#cb6-20"></a><span class="co">#&gt;    carat cut   color clarity depth table price     x     y     z</span></span>
<span id="cb6-21"><a href="#cb6-21"></a><span class="co">#&gt;    &lt;dbl&gt; &lt;ord&gt; &lt;ord&gt; &lt;ord&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb6-22"><a href="#cb6-22"></a><span class="co">#&gt;  1  0.23 Good  E     VS1      56.9    65   327  4.05  4.07  2.31</span></span>
<span id="cb6-23"><a href="#cb6-23"></a><span class="co">#&gt;  2  0.31 Good  J     SI2      63.3    58   335  4.34  4.35  2.75</span></span>
<span id="cb6-24"><a href="#cb6-24"></a><span class="co">#&gt;  3  0.3  Good  J     SI1      64      55   339  4.25  4.28  2.73</span></span>
<span id="cb6-25"><a href="#cb6-25"></a><span class="co">#&gt;  4  0.3  Good  J     SI1      63.4    54   351  4.23  4.29  2.7 </span></span>
<span id="cb6-26"><a href="#cb6-26"></a><span class="co">#&gt;  5  0.3  Good  J     SI1      63.8    56   351  4.23  4.26  2.71</span></span>
<span id="cb6-27"><a href="#cb6-27"></a><span class="co">#&gt;  6  0.3  Good  I     SI2      63.3    56   351  4.26  4.3   2.71</span></span>
<span id="cb6-28"><a href="#cb6-28"></a><span class="co">#&gt;  7  0.23 Good  F     VS1      58.2    59   402  4.06  4.08  2.37</span></span>
<span id="cb6-29"><a href="#cb6-29"></a><span class="co">#&gt;  8  0.23 Good  E     VS1      64.1    59   402  3.83  3.85  2.46</span></span>
<span id="cb6-30"><a href="#cb6-30"></a><span class="co">#&gt;  9  0.31 Good  H     SI1      64      54   402  4.29  4.31  2.75</span></span>
<span id="cb6-31"><a href="#cb6-31"></a><span class="co">#&gt; 10  0.26 Good  D     VS2      65.2    56   403  3.99  4.02  2.61</span></span>
<span id="cb6-32"><a href="#cb6-32"></a><span class="co">#&gt; # ... with 4,896 more rows</span></span>
<span id="cb6-33"><a href="#cb6-33"></a><span class="co">#&gt; </span></span>
<span id="cb6-34"><a href="#cb6-34"></a><span class="co">#&gt; $`Very Good`</span></span>
<span id="cb6-35"><a href="#cb6-35"></a><span class="co">#&gt; # A tibble: 12,082 x 10</span></span>
<span id="cb6-36"><a href="#cb6-36"></a><span class="co">#&gt;    carat cut       color clarity depth table price     x     y     z</span></span>
<span id="cb6-37"><a href="#cb6-37"></a><span class="co">#&gt;    &lt;dbl&gt; &lt;ord&gt;     &lt;ord&gt; &lt;ord&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb6-38"><a href="#cb6-38"></a><span class="co">#&gt;  1  0.24 Very Good J     VVS2     62.8    57   336  3.94  3.96  2.48</span></span>
<span id="cb6-39"><a href="#cb6-39"></a><span class="co">#&gt;  2  0.24 Very Good I     VVS1     62.3    57   336  3.95  3.98  2.47</span></span>
<span id="cb6-40"><a href="#cb6-40"></a><span class="co">#&gt;  3  0.26 Very Good H     SI1      61.9    55   337  4.07  4.11  2.53</span></span>
<span id="cb6-41"><a href="#cb6-41"></a><span class="co">#&gt;  4  0.23 Very Good H     VS1      59.4    61   338  4     4.05  2.39</span></span>
<span id="cb6-42"><a href="#cb6-42"></a><span class="co">#&gt;  5  0.3  Very Good J     SI1      62.7    59   351  4.21  4.27  2.66</span></span>
<span id="cb6-43"><a href="#cb6-43"></a><span class="co">#&gt;  6  0.23 Very Good E     VS2      63.8    55   352  3.85  3.92  2.48</span></span>
<span id="cb6-44"><a href="#cb6-44"></a><span class="co">#&gt;  7  0.23 Very Good H     VS1      61      57   353  3.94  3.96  2.41</span></span>
<span id="cb6-45"><a href="#cb6-45"></a><span class="co">#&gt;  8  0.31 Very Good J     SI1      59.4    62   353  4.39  4.43  2.62</span></span>
<span id="cb6-46"><a href="#cb6-46"></a><span class="co">#&gt;  9  0.31 Very Good J     SI1      58.1    62   353  4.44  4.47  2.59</span></span>
<span id="cb6-47"><a href="#cb6-47"></a><span class="co">#&gt; 10  0.23 Very Good G     VVS2     60.4    58   354  3.97  4.01  2.41</span></span>
<span id="cb6-48"><a href="#cb6-48"></a><span class="co">#&gt; # ... with 12,072 more rows</span></span>
<span id="cb6-49"><a href="#cb6-49"></a><span class="co">#&gt; </span></span>
<span id="cb6-50"><a href="#cb6-50"></a><span class="co">#&gt; $Premium</span></span>
<span id="cb6-51"><a href="#cb6-51"></a><span class="co">#&gt; # A tibble: 13,791 x 10</span></span>
<span id="cb6-52"><a href="#cb6-52"></a><span class="co">#&gt;    carat cut     color clarity depth table price     x     y     z</span></span>
<span id="cb6-53"><a href="#cb6-53"></a><span class="co">#&gt;    &lt;dbl&gt; &lt;ord&gt;   &lt;ord&gt; &lt;ord&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb6-54"><a href="#cb6-54"></a><span class="co">#&gt;  1 0.21  Premium E     SI1      59.8    61   326  3.89  3.84  2.31</span></span>
<span id="cb6-55"><a href="#cb6-55"></a><span class="co">#&gt;  2 0.290 Premium I     VS2      62.4    58   334  4.2   4.23  2.63</span></span>
<span id="cb6-56"><a href="#cb6-56"></a><span class="co">#&gt;  3 0.22  Premium F     SI1      60.4    61   342  3.88  3.84  2.33</span></span>
<span id="cb6-57"><a href="#cb6-57"></a><span class="co">#&gt;  4 0.2   Premium E     SI2      60.2    62   345  3.79  3.75  2.27</span></span>
<span id="cb6-58"><a href="#cb6-58"></a><span class="co">#&gt;  5 0.32  Premium E     I1       60.9    58   345  4.38  4.42  2.68</span></span>
<span id="cb6-59"><a href="#cb6-59"></a><span class="co">#&gt;  6 0.24  Premium I     VS1      62.5    57   355  3.97  3.94  2.47</span></span>
<span id="cb6-60"><a href="#cb6-60"></a><span class="co">#&gt;  7 0.290 Premium F     SI1      62.4    58   403  4.24  4.26  2.65</span></span>
<span id="cb6-61"><a href="#cb6-61"></a><span class="co">#&gt;  8 0.22  Premium E     VS2      61.6    58   404  3.93  3.89  2.41</span></span>
<span id="cb6-62"><a href="#cb6-62"></a><span class="co">#&gt;  9 0.22  Premium D     VS2      59.3    62   404  3.91  3.88  2.31</span></span>
<span id="cb6-63"><a href="#cb6-63"></a><span class="co">#&gt; 10 0.3   Premium J     SI2      59.3    61   405  4.43  4.38  2.61</span></span>
<span id="cb6-64"><a href="#cb6-64"></a><span class="co">#&gt; # ... with 13,781 more rows</span></span>
<span id="cb6-65"><a href="#cb6-65"></a><span class="co">#&gt; </span></span>
<span id="cb6-66"><a href="#cb6-66"></a><span class="co">#&gt; $Ideal</span></span>
<span id="cb6-67"><a href="#cb6-67"></a><span class="co">#&gt; # A tibble: 21,551 x 10</span></span>
<span id="cb6-68"><a href="#cb6-68"></a><span class="co">#&gt;    carat cut   color clarity depth table price     x     y     z</span></span>
<span id="cb6-69"><a href="#cb6-69"></a><span class="co">#&gt;    &lt;dbl&gt; &lt;ord&gt; &lt;ord&gt; &lt;ord&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb6-70"><a href="#cb6-70"></a><span class="co">#&gt;  1  0.23 Ideal E     SI2      61.5    55   326  3.95  3.98  2.43</span></span>
<span id="cb6-71"><a href="#cb6-71"></a><span class="co">#&gt;  2  0.23 Ideal J     VS1      62.8    56   340  3.93  3.9   2.46</span></span>
<span id="cb6-72"><a href="#cb6-72"></a><span class="co">#&gt;  3  0.31 Ideal J     SI2      62.2    54   344  4.35  4.37  2.71</span></span>
<span id="cb6-73"><a href="#cb6-73"></a><span class="co">#&gt;  4  0.3  Ideal I     SI2      62      54   348  4.31  4.34  2.68</span></span>
<span id="cb6-74"><a href="#cb6-74"></a><span class="co">#&gt;  5  0.33 Ideal I     SI2      61.8    55   403  4.49  4.51  2.78</span></span>
<span id="cb6-75"><a href="#cb6-75"></a><span class="co">#&gt;  6  0.33 Ideal I     SI2      61.2    56   403  4.49  4.5   2.75</span></span>
<span id="cb6-76"><a href="#cb6-76"></a><span class="co">#&gt;  7  0.33 Ideal J     SI1      61.1    56   403  4.49  4.55  2.76</span></span>
<span id="cb6-77"><a href="#cb6-77"></a><span class="co">#&gt;  8  0.23 Ideal G     VS1      61.9    54   404  3.93  3.95  2.44</span></span>
<span id="cb6-78"><a href="#cb6-78"></a><span class="co">#&gt;  9  0.32 Ideal I     SI1      60.9    55   404  4.45  4.48  2.72</span></span>
<span id="cb6-79"><a href="#cb6-79"></a><span class="co">#&gt; 10  0.3  Ideal I     SI2      61      59   405  4.3   4.33  2.63</span></span>
<span id="cb6-80"><a href="#cb6-80"></a><span class="co">#&gt; # ... with 21,541 more rows</span></span></code></pre></div>
<p>As it happens, the <code><a href="https://purrr.tidyverse.org/reference/map.html">purrr::map()</a></code> functions work quite well on the output of <code><a href="https://www.rdocumentation.org/packages/base/topics/split">split()</a></code>:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>diamonds <span class="op">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/split">split</a></span>(diamonds<span class="op">$</span>cut) <span class="op">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="st">  </span><span class="kw">map_dbl</span>(<span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.<span class="op">$</span>price))</span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="co">#&gt;      Fair      Good Very Good   Premium     Ideal </span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co">#&gt;  4358.758  3928.864  3981.760  4584.258  3457.542</span></span></code></pre></div>
<p>But this starts to get really unwieldy as you add more grouping variables. In particular, “meta data”— data about the groups—are either stuck inside the original data frames or are encoded in the name of each data frame in the list. It’s also difficult to do a sequence of operations and keep everything associated with the original groupings:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>diamonds_list =<span class="st"> </span>diamonds <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/split">split</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(diamonds<span class="op">$</span>cut, diamonds<span class="op">$</span>color))</span>
<span id="cb8-2"><a href="#cb8-2"></a></span>
<span id="cb8-3"><a href="#cb8-3"></a><span class="kw">map_dbl</span>(diamonds_list, <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.<span class="op">$</span>price))</span>
<span id="cb8-4"><a href="#cb8-4"></a><span class="co">#&gt;      Fair.D      Good.D Very Good.D   Premium.D     Ideal.D      Fair.E </span></span>
<span id="cb8-5"><a href="#cb8-5"></a><span class="co">#&gt;    4291.061    3405.382    3470.467    3631.293    2629.095    3682.312 </span></span>
<span id="cb8-6"><a href="#cb8-6"></a><span class="co">#&gt;      Good.E Very Good.E   Premium.E     Ideal.E      Fair.F      Good.F </span></span>
<span id="cb8-7"><a href="#cb8-7"></a><span class="co">#&gt;    3423.644    3214.652    3538.914    2597.550    3827.003    3495.750 </span></span>
<span id="cb8-8"><a href="#cb8-8"></a><span class="co">#&gt; Very Good.F   Premium.F     Ideal.F      Fair.G      Good.G Very Good.G </span></span>
<span id="cb8-9"><a href="#cb8-9"></a><span class="co">#&gt;    3778.820    4324.890    3374.939    4239.255    4123.482    3872.754 </span></span>
<span id="cb8-10"><a href="#cb8-10"></a><span class="co">#&gt;   Premium.G     Ideal.G      Fair.H      Good.H Very Good.H   Premium.H </span></span>
<span id="cb8-11"><a href="#cb8-11"></a><span class="co">#&gt;    4500.742    3720.706    5135.683    4276.255    4535.390    5216.707 </span></span>
<span id="cb8-12"><a href="#cb8-12"></a><span class="co">#&gt;     Ideal.H      Fair.I      Good.I Very Good.I   Premium.I     Ideal.I </span></span>
<span id="cb8-13"><a href="#cb8-13"></a><span class="co">#&gt;    3889.335    4685.446    5078.533    5255.880    5946.181    4451.970 </span></span>
<span id="cb8-14"><a href="#cb8-14"></a><span class="co">#&gt;      Fair.J      Good.J Very Good.J   Premium.J     Ideal.J </span></span>
<span id="cb8-15"><a href="#cb8-15"></a><span class="co">#&gt;    4975.655    4574.173    5103.513    6294.592    4918.186</span></span>
<span id="cb8-16"><a href="#cb8-16"></a><span class="kw">map_dbl</span>(diamonds_list, <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">cor</a></span>(.<span class="op">$</span>price, .<span class="op">$</span>depth))</span>
<span id="cb8-17"><a href="#cb8-17"></a><span class="co">#&gt;        Fair.D        Good.D   Very Good.D     Premium.D       Ideal.D </span></span>
<span id="cb8-18"><a href="#cb8-18"></a><span class="co">#&gt;  0.0085615605 -0.0554075394 -0.0372811241 -0.0137925475 -0.0002403403 </span></span>
<span id="cb8-19"><a href="#cb8-19"></a><span class="co">#&gt;        Fair.E        Good.E   Very Good.E     Premium.E       Ideal.E </span></span>
<span id="cb8-20"><a href="#cb8-20"></a><span class="co">#&gt;  0.0250744630  0.0075789572 -0.0089509102 -0.0116591653 -0.0017429526 </span></span>
<span id="cb8-21"><a href="#cb8-21"></a><span class="co">#&gt;        Fair.F        Good.F   Very Good.F     Premium.F       Ideal.F </span></span>
<span id="cb8-22"><a href="#cb8-22"></a><span class="co">#&gt;  0.0439661957  0.0058578333  0.0187700133  0.0264426847  0.0243688006 </span></span>
<span id="cb8-23"><a href="#cb8-23"></a><span class="co">#&gt;        Fair.G        Good.G   Very Good.G     Premium.G       Ideal.G </span></span>
<span id="cb8-24"><a href="#cb8-24"></a><span class="co">#&gt;  0.0274192215 -0.0334169977  0.0256327220 -0.0031418182 -0.0192370909 </span></span>
<span id="cb8-25"><a href="#cb8-25"></a><span class="co">#&gt;        Fair.H        Good.H   Very Good.H     Premium.H       Ideal.H </span></span>
<span id="cb8-26"><a href="#cb8-26"></a><span class="co">#&gt; -0.0837262712 -0.1247398747 -0.0078286322 -0.0030060456  0.0408014981 </span></span>
<span id="cb8-27"><a href="#cb8-27"></a><span class="co">#&gt;        Fair.I        Good.I   Very Good.I     Premium.I       Ideal.I </span></span>
<span id="cb8-28"><a href="#cb8-28"></a><span class="co">#&gt;  0.0398190356 -0.2020227152 -0.1033508965 -0.0836557999  0.0077703288 </span></span>
<span id="cb8-29"><a href="#cb8-29"></a><span class="co">#&gt;        Fair.J        Good.J   Very Good.J     Premium.J       Ideal.J </span></span>
<span id="cb8-30"><a href="#cb8-30"></a><span class="co">#&gt;  0.0192386809 -0.0709194473 -0.0789113617 -0.0156086436  0.0347510368</span></span></code></pre></div>
<p>Yuck. Nested data frames, which are supported by tibbles, make this much easier to handle:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a>nested_diamonds =</span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="st">  </span>diamonds <span class="op">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="st">  </span><span class="kw">select</span>(cut, color, clarity, depth, price) <span class="op">%&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="st">  </span><span class="kw">nest</span>(<span class="op">-</span>cut, <span class="op">-</span>color)</span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="co">#&gt; Warning: All elements of `...` must be named.</span></span>
<span id="cb9-6"><a href="#cb9-6"></a><span class="co">#&gt; Did you want `data = c(clarity, depth, price)`?</span></span>
<span id="cb9-7"><a href="#cb9-7"></a></span>
<span id="cb9-8"><a href="#cb9-8"></a>nested_diamonds</span>
<span id="cb9-9"><a href="#cb9-9"></a><span class="co">#&gt; # A tibble: 35 x 3</span></span>
<span id="cb9-10"><a href="#cb9-10"></a><span class="co">#&gt;    cut       color data                </span></span>
<span id="cb9-11"><a href="#cb9-11"></a><span class="co">#&gt;    &lt;ord&gt;     &lt;ord&gt; &lt;list&gt;              </span></span>
<span id="cb9-12"><a href="#cb9-12"></a><span class="co">#&gt;  1 Ideal     E     &lt;tibble [3,903 x 3]&gt;</span></span>
<span id="cb9-13"><a href="#cb9-13"></a><span class="co">#&gt;  2 Premium   E     &lt;tibble [2,337 x 3]&gt;</span></span>
<span id="cb9-14"><a href="#cb9-14"></a><span class="co">#&gt;  3 Good      E     &lt;tibble [933 x 3]&gt;  </span></span>
<span id="cb9-15"><a href="#cb9-15"></a><span class="co">#&gt;  4 Premium   I     &lt;tibble [1,428 x 3]&gt;</span></span>
<span id="cb9-16"><a href="#cb9-16"></a><span class="co">#&gt;  5 Good      J     &lt;tibble [307 x 3]&gt;  </span></span>
<span id="cb9-17"><a href="#cb9-17"></a><span class="co">#&gt;  6 Very Good J     &lt;tibble [678 x 3]&gt;  </span></span>
<span id="cb9-18"><a href="#cb9-18"></a><span class="co">#&gt;  7 Very Good I     &lt;tibble [1,204 x 3]&gt;</span></span>
<span id="cb9-19"><a href="#cb9-19"></a><span class="co">#&gt;  8 Very Good H     &lt;tibble [1,824 x 3]&gt;</span></span>
<span id="cb9-20"><a href="#cb9-20"></a><span class="co">#&gt;  9 Fair      E     &lt;tibble [224 x 3]&gt;  </span></span>
<span id="cb9-21"><a href="#cb9-21"></a><span class="co">#&gt; 10 Ideal     J     &lt;tibble [896 x 3]&gt;  </span></span>
<span id="cb9-22"><a href="#cb9-22"></a><span class="co">#&gt; # ... with 25 more rows</span></span></code></pre></div>
<p>What are we looking at here? We still have our grouping variables as columns, but each unique combination only takes up one row—and we have another, <code>data</code>, that says it’s a tibble. The column isn’t a vector but a list, and if we look at the elements in it we can see the other columns:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1"></a>nested_diamonds<span class="op">$</span>data[[<span class="dv">1</span>]]</span>
<span id="cb10-2"><a href="#cb10-2"></a><span class="co">#&gt; # A tibble: 3,903 x 3</span></span>
<span id="cb10-3"><a href="#cb10-3"></a><span class="co">#&gt;    clarity depth price</span></span>
<span id="cb10-4"><a href="#cb10-4"></a><span class="co">#&gt;    &lt;ord&gt;   &lt;dbl&gt; &lt;int&gt;</span></span>
<span id="cb10-5"><a href="#cb10-5"></a><span class="co">#&gt;  1 SI2      61.5   326</span></span>
<span id="cb10-6"><a href="#cb10-6"></a><span class="co">#&gt;  2 VVS2     62.9   554</span></span>
<span id="cb10-7"><a href="#cb10-7"></a><span class="co">#&gt;  3 SI1      62.5  2757</span></span>
<span id="cb10-8"><a href="#cb10-8"></a><span class="co">#&gt;  4 VVS2     62    2761</span></span>
<span id="cb10-9"><a href="#cb10-9"></a><span class="co">#&gt;  5 SI2      62.2  2761</span></span>
<span id="cb10-10"><a href="#cb10-10"></a><span class="co">#&gt;  6 VS2      60.7  2762</span></span>
<span id="cb10-11"><a href="#cb10-11"></a><span class="co">#&gt;  7 SI1      62.3  2762</span></span>
<span id="cb10-12"><a href="#cb10-12"></a><span class="co">#&gt;  8 SI1      60.9  2768</span></span>
<span id="cb10-13"><a href="#cb10-13"></a><span class="co">#&gt;  9 VS1      61.7  2774</span></span>
<span id="cb10-14"><a href="#cb10-14"></a><span class="co">#&gt; 10 SI1      62.7  2774</span></span>
<span id="cb10-15"><a href="#cb10-15"></a><span class="co">#&gt; # ... with 3,893 more rows</span></span>
<span id="cb10-16"><a href="#cb10-16"></a></span>
<span id="cb10-17"><a href="#cb10-17"></a>nested_diamonds<span class="op">$</span>data[[<span class="dv">2</span>]]</span>
<span id="cb10-18"><a href="#cb10-18"></a><span class="co">#&gt; # A tibble: 2,337 x 3</span></span>
<span id="cb10-19"><a href="#cb10-19"></a><span class="co">#&gt;    clarity depth price</span></span>
<span id="cb10-20"><a href="#cb10-20"></a><span class="co">#&gt;    &lt;ord&gt;   &lt;dbl&gt; &lt;int&gt;</span></span>
<span id="cb10-21"><a href="#cb10-21"></a><span class="co">#&gt;  1 SI1      59.8   326</span></span>
<span id="cb10-22"><a href="#cb10-22"></a><span class="co">#&gt;  2 SI2      60.2   345</span></span>
<span id="cb10-23"><a href="#cb10-23"></a><span class="co">#&gt;  3 I1       60.9   345</span></span>
<span id="cb10-24"><a href="#cb10-24"></a><span class="co">#&gt;  4 VS2      61.6   404</span></span>
<span id="cb10-25"><a href="#cb10-25"></a><span class="co">#&gt;  5 VVS1     60.7   553</span></span>
<span id="cb10-26"><a href="#cb10-26"></a><span class="co">#&gt;  6 SI1      59.9  2760</span></span>
<span id="cb10-27"><a href="#cb10-27"></a><span class="co">#&gt;  7 VVS1     60.9  2765</span></span>
<span id="cb10-28"><a href="#cb10-28"></a><span class="co">#&gt;  8 VS2      62.7  2776</span></span>
<span id="cb10-29"><a href="#cb10-29"></a><span class="co">#&gt;  9 VS2      61.1  2777</span></span>
<span id="cb10-30"><a href="#cb10-30"></a><span class="co">#&gt; 10 SI1      60    2777</span></span>
<span id="cb10-31"><a href="#cb10-31"></a><span class="co">#&gt; # ... with 2,327 more rows</span></span></code></pre></div>
<p>Not only do we have our group identifiers associated with each data frame now, but we can create other outputs and keep <em>them</em> associated with the groups too:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a>nested_diamonds <span class="op">%&gt;%</span></span>
<span id="cb11-2"><a href="#cb11-2"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb11-3"><a href="#cb11-3"></a>    <span class="dt">mean_price =</span> <span class="kw">map_dbl</span>(data, <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/mean">mean</a></span>(.<span class="op">$</span>price)),</span>
<span id="cb11-4"><a href="#cb11-4"></a>    <span class="dt">pd_cor =</span>     <span class="kw">map_dbl</span>(data, <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/cor">cor</a></span>(.<span class="op">$</span>price, .<span class="op">$</span>depth)))</span>
<span id="cb11-5"><a href="#cb11-5"></a><span class="co">#&gt; # A tibble: 35 x 5</span></span>
<span id="cb11-6"><a href="#cb11-6"></a><span class="co">#&gt;    cut       color data                 mean_price   pd_cor</span></span>
<span id="cb11-7"><a href="#cb11-7"></a><span class="co">#&gt;    &lt;ord&gt;     &lt;ord&gt; &lt;list&gt;                    &lt;dbl&gt;    &lt;dbl&gt;</span></span>
<span id="cb11-8"><a href="#cb11-8"></a><span class="co">#&gt;  1 Ideal     E     &lt;tibble [3,903 x 3]&gt;      2598. -0.00174</span></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="co">#&gt;  2 Premium   E     &lt;tibble [2,337 x 3]&gt;      3539. -0.0117 </span></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="co">#&gt;  3 Good      E     &lt;tibble [933 x 3]&gt;        3424.  0.00758</span></span>
<span id="cb11-11"><a href="#cb11-11"></a><span class="co">#&gt;  4 Premium   I     &lt;tibble [1,428 x 3]&gt;      5946. -0.0837 </span></span>
<span id="cb11-12"><a href="#cb11-12"></a><span class="co">#&gt;  5 Good      J     &lt;tibble [307 x 3]&gt;        4574. -0.0709 </span></span>
<span id="cb11-13"><a href="#cb11-13"></a><span class="co">#&gt;  6 Very Good J     &lt;tibble [678 x 3]&gt;        5104. -0.0789 </span></span>
<span id="cb11-14"><a href="#cb11-14"></a><span class="co">#&gt;  7 Very Good I     &lt;tibble [1,204 x 3]&gt;      5256. -0.103  </span></span>
<span id="cb11-15"><a href="#cb11-15"></a><span class="co">#&gt;  8 Very Good H     &lt;tibble [1,824 x 3]&gt;      4535. -0.00783</span></span>
<span id="cb11-16"><a href="#cb11-16"></a><span class="co">#&gt;  9 Fair      E     &lt;tibble [224 x 3]&gt;        3682.  0.0251 </span></span>
<span id="cb11-17"><a href="#cb11-17"></a><span class="co">#&gt; 10 Ideal     J     &lt;tibble [896 x 3]&gt;        4918.  0.0348 </span></span>
<span id="cb11-18"><a href="#cb11-18"></a><span class="co">#&gt; # ... with 25 more rows</span></span></code></pre></div>
<p>We can even do complex things like build regression models on the groups:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a></span>
<span id="cb12-2"><a href="#cb12-2"></a>diamonds_models =</span>
<span id="cb12-3"><a href="#cb12-3"></a><span class="st">  </span>nested_diamonds <span class="op">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb12-5"><a href="#cb12-5"></a>    <span class="dt">price_mod =</span> <span class="kw">map</span>(data, <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/lm">lm</a></span>(.<span class="op">$</span>price <span class="op">~</span><span class="st"> </span>.<span class="op">$</span>depth)),</span>
<span id="cb12-6"><a href="#cb12-6"></a>    <span class="dt">price_summary =</span> <span class="kw">map</span>(price_mod, summary),</span>
<span id="cb12-7"><a href="#cb12-7"></a>    <span class="dt">price_rsq =</span> <span class="kw">map_dbl</span>(price_summary, <span class="st">'r.squared'</span>))</span>
<span id="cb12-8"><a href="#cb12-8"></a></span>
<span id="cb12-9"><a href="#cb12-9"></a>diamonds_models</span>
<span id="cb12-10"><a href="#cb12-10"></a><span class="co">#&gt; # A tibble: 35 x 6</span></span>
<span id="cb12-11"><a href="#cb12-11"></a><span class="co">#&gt;    cut       color data                 price_mod price_summary  price_rsq</span></span>
<span id="cb12-12"><a href="#cb12-12"></a><span class="co">#&gt;    &lt;ord&gt;     &lt;ord&gt; &lt;list&gt;               &lt;list&gt;    &lt;list&gt;             &lt;dbl&gt;</span></span>
<span id="cb12-13"><a href="#cb12-13"></a><span class="co">#&gt;  1 Ideal     E     &lt;tibble [3,903 x 3]&gt; &lt;lm&gt;      &lt;smmry.lm&gt;    0.00000304</span></span>
<span id="cb12-14"><a href="#cb12-14"></a><span class="co">#&gt;  2 Premium   E     &lt;tibble [2,337 x 3]&gt; &lt;lm&gt;      &lt;smmry.lm&gt;    0.000136  </span></span>
<span id="cb12-15"><a href="#cb12-15"></a><span class="co">#&gt;  3 Good      E     &lt;tibble [933 x 3]&gt;   &lt;lm&gt;      &lt;smmry.lm&gt;    0.0000574 </span></span>
<span id="cb12-16"><a href="#cb12-16"></a><span class="co">#&gt;  4 Premium   I     &lt;tibble [1,428 x 3]&gt; &lt;lm&gt;      &lt;smmry.lm&gt;    0.00700   </span></span>
<span id="cb12-17"><a href="#cb12-17"></a><span class="co">#&gt;  5 Good      J     &lt;tibble [307 x 3]&gt;   &lt;lm&gt;      &lt;smmry.lm&gt;    0.00503   </span></span>
<span id="cb12-18"><a href="#cb12-18"></a><span class="co">#&gt;  6 Very Good J     &lt;tibble [678 x 3]&gt;   &lt;lm&gt;      &lt;smmry.lm&gt;    0.00623   </span></span>
<span id="cb12-19"><a href="#cb12-19"></a><span class="co">#&gt;  7 Very Good I     &lt;tibble [1,204 x 3]&gt; &lt;lm&gt;      &lt;smmry.lm&gt;    0.0107    </span></span>
<span id="cb12-20"><a href="#cb12-20"></a><span class="co">#&gt;  8 Very Good H     &lt;tibble [1,824 x 3]&gt; &lt;lm&gt;      &lt;smmry.lm&gt;    0.0000613 </span></span>
<span id="cb12-21"><a href="#cb12-21"></a><span class="co">#&gt;  9 Fair      E     &lt;tibble [224 x 3]&gt;   &lt;lm&gt;      &lt;smmry.lm&gt;    0.000629  </span></span>
<span id="cb12-22"><a href="#cb12-22"></a><span class="co">#&gt; 10 Ideal     J     &lt;tibble [896 x 3]&gt;   &lt;lm&gt;      &lt;smmry.lm&gt;    0.00121   </span></span>
<span id="cb12-23"><a href="#cb12-23"></a><span class="co">#&gt; # ... with 25 more rows</span></span></code></pre></div>
<p>(These are pretty lousy models, but they’ll do for our purposes!)</p>
</div>
<div id="purrrnesting" class="section level1">
<h1 class="hasAnchor">
<a href="#purrrnesting" class="anchor"></a>Nesting and handling side effects with purrr</h1>
<p>We can carry on like this, adding analyses to the groups, but it’s also a pretty reckless way to operate. There could be anything going on in these list columns, and without being able to see them from the outside it’d be easy to miss a problem that turns up. In addition, we might hit an error and be unsure which group is causing it.</p>
<p>For example, if we remove all of the rows in one of the <code>data</code> groups, we’ll get this error:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>nested_diamonds<span class="op">$</span>data[[<span class="dv">5</span>]] =<span class="st"> </span>nested_diamonds<span class="op">$</span>data[[<span class="dv">5</span>]] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(price <span class="op">&lt;</span><span class="st"> </span><span class="dv">300</span>)</span>
<span id="cb13-2"><a href="#cb13-2"></a></span>
<span id="cb13-3"><a href="#cb13-3"></a>diamonds_models =</span>
<span id="cb13-4"><a href="#cb13-4"></a><span class="st">  </span>nested_diamonds <span class="op">%&gt;%</span></span>
<span id="cb13-5"><a href="#cb13-5"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb13-6"><a href="#cb13-6"></a>    <span class="dt">price_mod =</span> <span class="kw">map</span>(data, <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/lm">lm</a></span>(.<span class="op">$</span>price <span class="op">~</span><span class="st"> </span>.<span class="op">$</span>depth)),</span>
<span id="cb13-7"><a href="#cb13-7"></a>    <span class="dt">price_summary =</span> <span class="kw">map</span>(price_mod, summary),</span>
<span id="cb13-8"><a href="#cb13-8"></a>    <span class="dt">price_rsq =</span> <span class="kw">map_dbl</span>(price_summary, <span class="st">'r.squared'</span>))</span>
<span id="cb13-9"><a href="#cb13-9"></a></span>
<span id="cb13-10"><a href="#cb13-10"></a>diamonds_models</span>
<span id="cb13-11"><a href="#cb13-11"></a><span class="co">#&gt; Error in mutate_impl(.data, dots) : Evaluation error: 0 (non-NA) cases.</span></span></code></pre></div>
<p>We can see that there’s <em>a</em> problem here, but we have no idea which group is causing it without inspecting them (at least, we wouldn’t if we hadn’t just set this up!).</p>
<p><code>purrr</code> tries to tackle this with two functions: <a href="https://purrr.tidyverse.org/reference/safely.html"><code>safely()</code> and <code>quietly()</code></a>. The former catches errors; the latter catches warnings, messages and other output. You use it like this:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>safe_lm =<span class="st"> </span><span class="kw">safely</span>(lm)</span>
<span id="cb14-2"><a href="#cb14-2"></a>safe_summary =<span class="st"> </span><span class="kw">safely</span>(summary)</span>
<span id="cb14-3"><a href="#cb14-3"></a></span>
<span id="cb14-4"><a href="#cb14-4"></a>purrr_models =</span>
<span id="cb14-5"><a href="#cb14-5"></a><span class="st">  </span>nested_diamonds <span class="op">%&gt;%</span></span>
<span id="cb14-6"><a href="#cb14-6"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">price_mod =</span> <span class="kw">map</span>(data, <span class="op">~</span><span class="st"> </span><span class="kw">safe_lm</span>(.<span class="op">$</span>price <span class="op">~</span><span class="st"> </span>.<span class="op">$</span>depth)))</span>
<span id="cb14-7"><a href="#cb14-7"></a></span>
<span id="cb14-8"><a href="#cb14-8"></a>purrr_models</span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="co">#&gt; # A tibble: 35 x 4</span></span>
<span id="cb14-10"><a href="#cb14-10"></a><span class="co">#&gt;    cut       color data                 price_mod       </span></span>
<span id="cb14-11"><a href="#cb14-11"></a><span class="co">#&gt;    &lt;ord&gt;     &lt;ord&gt; &lt;list&gt;               &lt;list&gt;          </span></span>
<span id="cb14-12"><a href="#cb14-12"></a><span class="co">#&gt;  1 Ideal     E     &lt;tibble [3,903 x 3]&gt; &lt;named list [2]&gt;</span></span>
<span id="cb14-13"><a href="#cb14-13"></a><span class="co">#&gt;  2 Premium   E     &lt;tibble [2,337 x 3]&gt; &lt;named list [2]&gt;</span></span>
<span id="cb14-14"><a href="#cb14-14"></a><span class="co">#&gt;  3 Good      E     &lt;tibble [933 x 3]&gt;   &lt;named list [2]&gt;</span></span>
<span id="cb14-15"><a href="#cb14-15"></a><span class="co">#&gt;  4 Premium   I     &lt;tibble [1,428 x 3]&gt; &lt;named list [2]&gt;</span></span>
<span id="cb14-16"><a href="#cb14-16"></a><span class="co">#&gt;  5 Good      J     &lt;tibble [307 x 3]&gt;   &lt;named list [2]&gt;</span></span>
<span id="cb14-17"><a href="#cb14-17"></a><span class="co">#&gt;  6 Very Good J     &lt;tibble [678 x 3]&gt;   &lt;named list [2]&gt;</span></span>
<span id="cb14-18"><a href="#cb14-18"></a><span class="co">#&gt;  7 Very Good I     &lt;tibble [1,204 x 3]&gt; &lt;named list [2]&gt;</span></span>
<span id="cb14-19"><a href="#cb14-19"></a><span class="co">#&gt;  8 Very Good H     &lt;tibble [1,824 x 3]&gt; &lt;named list [2]&gt;</span></span>
<span id="cb14-20"><a href="#cb14-20"></a><span class="co">#&gt;  9 Fair      E     &lt;tibble [224 x 3]&gt;   &lt;named list [2]&gt;</span></span>
<span id="cb14-21"><a href="#cb14-21"></a><span class="co">#&gt; 10 Ideal     J     &lt;tibble [896 x 3]&gt;   &lt;named list [2]&gt;</span></span>
<span id="cb14-22"><a href="#cb14-22"></a><span class="co">#&gt; # ... with 25 more rows</span></span></code></pre></div>
<p>This is great! We bulldozed our way through the error, so we still have the other 34 models! In lieu of a list of model objects, <code>price_mod</code> is now a list of <em>lists</em>: each element of the column is a list with two elements: <code>$result</code> and <code>$error</code> (<code>quietly()</code> returns four components).</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>purrr_models<span class="op">$</span>price_mod[[<span class="dv">1</span>]]</span>
<span id="cb15-2"><a href="#cb15-2"></a><span class="co">#&gt; $result</span></span>
<span id="cb15-3"><a href="#cb15-3"></a><span class="co">#&gt; </span></span>
<span id="cb15-4"><a href="#cb15-4"></a><span class="co">#&gt; Call:</span></span>
<span id="cb15-5"><a href="#cb15-5"></a><span class="co">#&gt; .f(formula = ..1)</span></span>
<span id="cb15-6"><a href="#cb15-6"></a><span class="co">#&gt; </span></span>
<span id="cb15-7"><a href="#cb15-7"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb15-8"><a href="#cb15-8"></a><span class="co">#&gt; (Intercept)      .$depth  </span></span>
<span id="cb15-9"><a href="#cb15-9"></a><span class="co">#&gt;    3046.968       -7.285  </span></span>
<span id="cb15-10"><a href="#cb15-10"></a><span class="co">#&gt; </span></span>
<span id="cb15-11"><a href="#cb15-11"></a><span class="co">#&gt; </span></span>
<span id="cb15-12"><a href="#cb15-12"></a><span class="co">#&gt; $error</span></span>
<span id="cb15-13"><a href="#cb15-13"></a><span class="co">#&gt; NULL</span></span>
<span id="cb15-14"><a href="#cb15-14"></a></span>
<span id="cb15-15"><a href="#cb15-15"></a>purrr_models<span class="op">$</span>price_mod[[<span class="dv">5</span>]]</span>
<span id="cb15-16"><a href="#cb15-16"></a><span class="co">#&gt; $result</span></span>
<span id="cb15-17"><a href="#cb15-17"></a><span class="co">#&gt; </span></span>
<span id="cb15-18"><a href="#cb15-18"></a><span class="co">#&gt; Call:</span></span>
<span id="cb15-19"><a href="#cb15-19"></a><span class="co">#&gt; .f(formula = ..1)</span></span>
<span id="cb15-20"><a href="#cb15-20"></a><span class="co">#&gt; </span></span>
<span id="cb15-21"><a href="#cb15-21"></a><span class="co">#&gt; Coefficients:</span></span>
<span id="cb15-22"><a href="#cb15-22"></a><span class="co">#&gt; (Intercept)      .$depth  </span></span>
<span id="cb15-23"><a href="#cb15-23"></a><span class="co">#&gt;       12310         -124  </span></span>
<span id="cb15-24"><a href="#cb15-24"></a><span class="co">#&gt; </span></span>
<span id="cb15-25"><a href="#cb15-25"></a><span class="co">#&gt; </span></span>
<span id="cb15-26"><a href="#cb15-26"></a><span class="co">#&gt; $error</span></span>
<span id="cb15-27"><a href="#cb15-27"></a><span class="co">#&gt; NULL</span></span>
<span id="cb15-28"><a href="#cb15-28"></a></span>
<span id="cb15-29"><a href="#cb15-29"></a>purrr_models <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">mutate</span>(<span class="dt">mod_result =</span> <span class="kw">map</span>(price_mod, <span class="st">'result'</span>))</span>
<span id="cb15-30"><a href="#cb15-30"></a><span class="co">#&gt; # A tibble: 35 x 5</span></span>
<span id="cb15-31"><a href="#cb15-31"></a><span class="co">#&gt;    cut       color data                 price_mod        mod_result</span></span>
<span id="cb15-32"><a href="#cb15-32"></a><span class="co">#&gt;    &lt;ord&gt;     &lt;ord&gt; &lt;list&gt;               &lt;list&gt;           &lt;list&gt;    </span></span>
<span id="cb15-33"><a href="#cb15-33"></a><span class="co">#&gt;  1 Ideal     E     &lt;tibble [3,903 x 3]&gt; &lt;named list [2]&gt; &lt;lm&gt;      </span></span>
<span id="cb15-34"><a href="#cb15-34"></a><span class="co">#&gt;  2 Premium   E     &lt;tibble [2,337 x 3]&gt; &lt;named list [2]&gt; &lt;lm&gt;      </span></span>
<span id="cb15-35"><a href="#cb15-35"></a><span class="co">#&gt;  3 Good      E     &lt;tibble [933 x 3]&gt;   &lt;named list [2]&gt; &lt;lm&gt;      </span></span>
<span id="cb15-36"><a href="#cb15-36"></a><span class="co">#&gt;  4 Premium   I     &lt;tibble [1,428 x 3]&gt; &lt;named list [2]&gt; &lt;lm&gt;      </span></span>
<span id="cb15-37"><a href="#cb15-37"></a><span class="co">#&gt;  5 Good      J     &lt;tibble [307 x 3]&gt;   &lt;named list [2]&gt; &lt;lm&gt;      </span></span>
<span id="cb15-38"><a href="#cb15-38"></a><span class="co">#&gt;  6 Very Good J     &lt;tibble [678 x 3]&gt;   &lt;named list [2]&gt; &lt;lm&gt;      </span></span>
<span id="cb15-39"><a href="#cb15-39"></a><span class="co">#&gt;  7 Very Good I     &lt;tibble [1,204 x 3]&gt; &lt;named list [2]&gt; &lt;lm&gt;      </span></span>
<span id="cb15-40"><a href="#cb15-40"></a><span class="co">#&gt;  8 Very Good H     &lt;tibble [1,824 x 3]&gt; &lt;named list [2]&gt; &lt;lm&gt;      </span></span>
<span id="cb15-41"><a href="#cb15-41"></a><span class="co">#&gt;  9 Fair      E     &lt;tibble [224 x 3]&gt;   &lt;named list [2]&gt; &lt;lm&gt;      </span></span>
<span id="cb15-42"><a href="#cb15-42"></a><span class="co">#&gt; 10 Ideal     J     &lt;tibble [896 x 3]&gt;   &lt;named list [2]&gt; &lt;lm&gt;      </span></span>
<span id="cb15-43"><a href="#cb15-43"></a><span class="co">#&gt; # ... with 25 more rows</span></span></code></pre></div>
<p>We can now extract the <code>result</code> element using <code>map()</code>, and there’s a <code>NULL</code> value for the group that failed. But there are still some big problems here:</p>
<ol style="list-style-type: decimal">
<li>We have to remember to wrap each function in <code>safely()</code> or <code>quietly()</code> ahead of time; and</li>
<li>We have to check each element of the list column, or carefully extract the results, to locate the problem.</li>
</ol>
</div>
<div id="collateraluse" class="section level1">
<h1 class="hasAnchor">
<a href="#collateraluse" class="anchor"></a>Collateral: capture, identify and isolate side effects</h1>
<p>The idea of <code>collateral</code> is to both make these functions easier to use and to make them more powerful. Instead of wrapping our functions ourselves, we use <code>map()</code> variants:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(collateral)</span>
<span id="cb16-2"><a href="#cb16-2"></a></span>
<span id="cb16-3"><a href="#cb16-3"></a>nested_diamonds<span class="op">$</span>data[[<span class="dv">5</span>]] =<span class="st"> </span>nested_diamonds<span class="op">$</span>data[[<span class="dv">5</span>]] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(price <span class="op">&lt;</span><span class="st"> </span><span class="dv">300</span>)</span>
<span id="cb16-4"><a href="#cb16-4"></a></span>
<span id="cb16-5"><a href="#cb16-5"></a>collat_models =</span>
<span id="cb16-6"><a href="#cb16-6"></a><span class="st">  </span>nested_diamonds <span class="op">%&gt;%</span></span>
<span id="cb16-7"><a href="#cb16-7"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">price_mod =</span> <span class="kw"><a href="../reference/collateral_mappers.html">map_safely</a></span>(data, <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/lm">lm</a></span>(.<span class="op">$</span>price <span class="op">~</span><span class="st"> </span>.<span class="op">$</span>depth)))</span>
<span id="cb16-8"><a href="#cb16-8"></a></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(collat_models)</span>
<span id="cb16-10"><a href="#cb16-10"></a><span class="co">#&gt; # A tibble: 35 x 4</span></span>
<span id="cb16-11"><a href="#cb16-11"></a><span class="co">#&gt;    cut       color data                 price_mod</span></span>
<span id="cb16-12"><a href="#cb16-12"></a><span class="co">#&gt;    &lt;ord&gt;     &lt;ord&gt; &lt;list&gt;               &lt;collat&gt; </span></span>
<span id="cb16-13"><a href="#cb16-13"></a><span class="co">#&gt;  1 Ideal     E     &lt;tibble [3,903 x 3]&gt; R _      </span></span>
<span id="cb16-14"><a href="#cb16-14"></a><span class="co">#&gt;  2 Premium   E     &lt;tibble [2,337 x 3]&gt; R _      </span></span>
<span id="cb16-15"><a href="#cb16-15"></a><span class="co">#&gt;  3 Good      E     &lt;tibble [933 x 3]&gt;   R _      </span></span>
<span id="cb16-16"><a href="#cb16-16"></a><span class="co">#&gt;  4 Premium   I     &lt;tibble [1,428 x 3]&gt; R _      </span></span>
<span id="cb16-17"><a href="#cb16-17"></a><span class="co">#&gt;  5 Good      J     &lt;tibble [0 x 3]&gt;     _ E      </span></span>
<span id="cb16-18"><a href="#cb16-18"></a><span class="co">#&gt;  6 Very Good J     &lt;tibble [678 x 3]&gt;   R _      </span></span>
<span id="cb16-19"><a href="#cb16-19"></a><span class="co">#&gt;  7 Very Good I     &lt;tibble [1,204 x 3]&gt; R _      </span></span>
<span id="cb16-20"><a href="#cb16-20"></a><span class="co">#&gt;  8 Very Good H     &lt;tibble [1,824 x 3]&gt; R _      </span></span>
<span id="cb16-21"><a href="#cb16-21"></a><span class="co">#&gt;  9 Fair      E     &lt;tibble [224 x 3]&gt;   R _      </span></span>
<span id="cb16-22"><a href="#cb16-22"></a><span class="co">#&gt; 10 Ideal     J     &lt;tibble [896 x 3]&gt;   R _      </span></span>
<span id="cb16-23"><a href="#cb16-23"></a><span class="co">#&gt; # ... with 25 more rows</span></span></code></pre></div>
<p>Now <code>price_mod</code> is a list of class <code>collat</code>, and scanning down it we can see which group hit an error immediately, all rows but the fifth are labelled <code>R</code>, for result, but the fifth is labelled <code>E</code>, for error.</p>
<p>If you’re working in a terminal that supports colour, this stands out even more:</p>
<div class="figure">
<img src="../man/figures/diamonds_models.png" alt=""><p class="caption">collat_models output, as seen in a terminal with colour</p>
</div>
<p>This <code>collateral</code> list-column is actually completely identical to the manually wrapped-and-mapped solution from <code>purrr</code>, other than the class name. The fancy tibble printing is totally separate from the content of the column and is handled using the <code>pillar</code> package (which provides extensions for tibble output), so if you’re already familiar with the <code>purrr</code> workflow you get immediate benefits.</p>
<p>You can, of course, pull out the results you would’ve gotten from a regular map (assuming you didn’t hit any errors), and you’ll probably <em>want</em> to do that in order to continue operating on those results. You can also extract other side effects, although keep in mind that:</p>
<ol style="list-style-type: decimal">
<li>The regular typed <code>map</code> variants, like <code>map_chr</code>, are excellent for extracting side effects quickly.</li>
<li>Unlike other kinds of output, errors aren’t just simple character vectors. Generally, you’ll want the <code>error$message</code>.</li>
<li>Sometimes an operation might deliver more than one warning, message or output per row. That means that you may need to concatenate several warnings together—using the <code>paste</code> function with the <code>collapse</code> option, for example.</li>
</ol>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1"></a>collat_models <span class="op">%&gt;%</span></span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="st">  </span><span class="kw">mutate</span>(</span>
<span id="cb17-3"><a href="#cb17-3"></a>    <span class="co"># this returns a list of `lm` objects</span></span>
<span id="cb17-4"><a href="#cb17-4"></a>    <span class="dt">mod_result =</span> <span class="kw">map</span>(price_mod, <span class="st">'result'</span>),</span>
<span id="cb17-5"><a href="#cb17-5"></a>    <span class="co"># this returns a character vector</span></span>
<span id="cb17-6"><a href="#cb17-6"></a>    <span class="dt">mod_error =</span> <span class="kw">map_chr</span>(price_mod, <span class="op">~</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(.x<span class="op">$</span>error<span class="op">$</span>message, <span class="dt">collapse =</span> <span class="st">' '</span>)))</span>
<span id="cb17-7"><a href="#cb17-7"></a><span class="co">#&gt; # A tibble: 35 x 6</span></span>
<span id="cb17-8"><a href="#cb17-8"></a><span class="co">#&gt;    cut       color data                 price_mod mod_result mod_error         </span></span>
<span id="cb17-9"><a href="#cb17-9"></a><span class="co">#&gt;    &lt;ord&gt;     &lt;ord&gt; &lt;list&gt;               &lt;collat&gt;  &lt;list&gt;     &lt;chr&gt;             </span></span>
<span id="cb17-10"><a href="#cb17-10"></a><span class="co">#&gt;  1 Ideal     E     &lt;tibble [3,903 x 3]&gt; R _       &lt;lm&gt;       ""                </span></span>
<span id="cb17-11"><a href="#cb17-11"></a><span class="co">#&gt;  2 Premium   E     &lt;tibble [2,337 x 3]&gt; R _       &lt;lm&gt;       ""                </span></span>
<span id="cb17-12"><a href="#cb17-12"></a><span class="co">#&gt;  3 Good      E     &lt;tibble [933 x 3]&gt;   R _       &lt;lm&gt;       ""                </span></span>
<span id="cb17-13"><a href="#cb17-13"></a><span class="co">#&gt;  4 Premium   I     &lt;tibble [1,428 x 3]&gt; R _       &lt;lm&gt;       ""                </span></span>
<span id="cb17-14"><a href="#cb17-14"></a><span class="co">#&gt;  5 Good      J     &lt;tibble [0 x 3]&gt;     _ E       &lt;NULL&gt;     "0 (non-NA) cases"</span></span>
<span id="cb17-15"><a href="#cb17-15"></a><span class="co">#&gt;  6 Very Good J     &lt;tibble [678 x 3]&gt;   R _       &lt;lm&gt;       ""                </span></span>
<span id="cb17-16"><a href="#cb17-16"></a><span class="co">#&gt;  7 Very Good I     &lt;tibble [1,204 x 3]&gt; R _       &lt;lm&gt;       ""                </span></span>
<span id="cb17-17"><a href="#cb17-17"></a><span class="co">#&gt;  8 Very Good H     &lt;tibble [1,824 x 3]&gt; R _       &lt;lm&gt;       ""                </span></span>
<span id="cb17-18"><a href="#cb17-18"></a><span class="co">#&gt;  9 Fair      E     &lt;tibble [224 x 3]&gt;   R _       &lt;lm&gt;       ""                </span></span>
<span id="cb17-19"><a href="#cb17-19"></a><span class="co">#&gt; 10 Ideal     J     &lt;tibble [896 x 3]&gt;   R _       &lt;lm&gt;       ""                </span></span>
<span id="cb17-20"><a href="#cb17-20"></a><span class="co">#&gt; # ... with 25 more rows</span></span></code></pre></div>
</div>
<div id="helpers" class="section level1">
<h1 class="hasAnchor">
<a href="#helpers" class="anchor"></a>Filtering on, and summarising, side effects</h1>
<p><code>collateral</code> also comes with some additional helpers. You can get a quick <code>summary</code> of the side effects (which also invisibly returns a named vecotr for non-interactive use):</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1"></a><span class="kw"><a href="../reference/summary.html">summary</a></span>(collat_models<span class="op">$</span>price_mod) </span>
<span id="cb18-2"><a href="#cb18-2"></a><span class="co">#&gt; 35 elements in total.</span></span>
<span id="cb18-3"><a href="#cb18-3"></a><span class="co">#&gt; 34 elements returned results, and</span></span>
<span id="cb18-4"><a href="#cb18-4"></a><span class="co">#&gt; 1 element encountered errors.</span></span></code></pre></div>
<p>You can also use the <code>tally_*()</code> functions in conjunction with <a href="https://dplyr.tidyverse.org/reference/summarise.html"><code><a href="https://dplyr.tidyverse.org/reference/summarise.html">dplyr::summarise()</a></code></a> to get a count of each component (even if the top-level data frame grouped again!) or <code>has_*()</code> to <a href="https://dplyr.tidyverse.org/reference/filter.html"><code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter()</a></code></a> out the rows that didn’t make it (or the ones that did):</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a>collat_models <span class="op">%&gt;%</span></span>
<span id="cb19-2"><a href="#cb19-2"></a><span class="st">  </span><span class="kw">group_by</span>(color) <span class="op">%&gt;%</span></span>
<span id="cb19-3"><a href="#cb19-3"></a><span class="st">  </span><span class="kw">summarise</span>(</span>
<span id="cb19-4"><a href="#cb19-4"></a>    <span class="dt">n_res =</span> <span class="kw"><a href="../reference/tally.html">tally_results</a></span>(price_mod),</span>
<span id="cb19-5"><a href="#cb19-5"></a>    <span class="dt">n_err =</span> <span class="kw"><a href="../reference/tally.html">tally_errors</a></span>(price_mod))</span>
<span id="cb19-6"><a href="#cb19-6"></a><span class="co">#&gt; # A tibble: 7 x 3</span></span>
<span id="cb19-7"><a href="#cb19-7"></a><span class="co">#&gt;   color n_res n_err</span></span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="co">#&gt; * &lt;ord&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="co">#&gt; 1 D         5     0</span></span>
<span id="cb19-10"><a href="#cb19-10"></a><span class="co">#&gt; 2 E         5     0</span></span>
<span id="cb19-11"><a href="#cb19-11"></a><span class="co">#&gt; 3 F         5     0</span></span>
<span id="cb19-12"><a href="#cb19-12"></a><span class="co">#&gt; 4 G         5     0</span></span>
<span id="cb19-13"><a href="#cb19-13"></a><span class="co">#&gt; 5 H         5     0</span></span>
<span id="cb19-14"><a href="#cb19-14"></a><span class="co">#&gt; 6 I         5     0</span></span>
<span id="cb19-15"><a href="#cb19-15"></a><span class="co">#&gt; 7 J         4     1</span></span>
<span id="cb19-16"><a href="#cb19-16"></a>    </span>
<span id="cb19-17"><a href="#cb19-17"></a>collat_models <span class="op">%&gt;%</span></span>
<span id="cb19-18"><a href="#cb19-18"></a><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(<span class="kw"><a href="../reference/has.html">has_errors</a></span>(price_mod))</span>
<span id="cb19-19"><a href="#cb19-19"></a><span class="co">#&gt; # A tibble: 1 x 4</span></span>
<span id="cb19-20"><a href="#cb19-20"></a><span class="co">#&gt;   cut   color data             price_mod</span></span>
<span id="cb19-21"><a href="#cb19-21"></a><span class="co">#&gt;   &lt;ord&gt; &lt;ord&gt; &lt;list&gt;           &lt;collat&gt; </span></span>
<span id="cb19-22"><a href="#cb19-22"></a><span class="co">#&gt; 1 Good  J     &lt;tibble [0 x 3]&gt; _ E</span></span>
<span id="cb19-23"><a href="#cb19-23"></a></span>
<span id="cb19-24"><a href="#cb19-24"></a>collat_models <span class="op">%&gt;%</span></span>
<span id="cb19-25"><a href="#cb19-25"></a><span class="st">  </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(<span class="op">!</span><span class="kw"><a href="../reference/has.html">has_results</a></span>(price_mod))</span>
<span id="cb19-26"><a href="#cb19-26"></a><span class="co">#&gt; # A tibble: 1 x 4</span></span>
<span id="cb19-27"><a href="#cb19-27"></a><span class="co">#&gt;   cut   color data             price_mod</span></span>
<span id="cb19-28"><a href="#cb19-28"></a><span class="co">#&gt;   &lt;ord&gt; &lt;ord&gt; &lt;list&gt;           &lt;collat&gt; </span></span>
<span id="cb19-29"><a href="#cb19-29"></a><span class="co">#&gt; 1 Good  J     &lt;tibble [0 x 3]&gt; _ E</span></span></code></pre></div>
<p>Together, these tools make debugging problems drastically easier, even if you need to run a thousand statistical models or analyse 500 datasets.</p>
</div>
<div id="further-tools" class="section level1">
<h1 class="hasAnchor">
<a href="#further-tools" class="anchor"></a>Further tools</h1>
<p>Occasionally, you may find that an operation could return either errors, warnings or <em>both</em>. For example, <code>log</code> outputs a warning when it’s given negative numebrs but throws an error if its input is non-numeric. Regression functions are particularly prone to this.</p>
<p>For these purposes, use <code>map_peacefully</code>, which works in the same way as <code>map_safely</code> and <code>map_quietly</code> but returns the side effects from both. If you aren’t sure which collateral mapper to reach for, start with this one!</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#contents">Contents</a></li>
      <li><a href="#eda">Basic exploratory analysis</a></li>
      <li><a href="#basegrouping">Grouping the traditional way</a></li>
      <li><a href="#purrrnesting">Nesting and handling side effects with purrr</a></li>
      <li><a href="#collateraluse">Collateral: capture, identify and isolate side effects</a></li>
      <li><a href="#helpers">Filtering on, and summarising, side effects</a></li>
      <li><a href="#further-tools">Further tools</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="https://rensa.co"><img src="https://rensa.co/assets/me.jpg" height="48"></a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
